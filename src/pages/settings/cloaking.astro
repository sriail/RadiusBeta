---
import SettingsLayout from "@layouts/SettingsLayout.astro";
import Input from "@components/ui/Input.astro";
import Button from "@components/ui/Button.astro";
import { Settings } from "@utils/settings.ts";
import { StoreManager } from "@utils/storage";
import { SW } from "@utils/proxy.ts";
---
<SettingsLayout active="cloaking" title="Cloaking">
    <div class="w-full flex-grow overflow-y-auto">
        <div class="w-full flex flex-row gap-4">
            <div class="w-1/2">
                <div>
                    <p> About Blank </p>
                    <Input id="aboutBlankCloaker" placeholder="Redirect url (EX: https://google.com)" />
                </div>
                <div class="mt-2">
                    <Button id="aboutBlankLaunch" text="Cloak!" icon="material-symbols:open-in-new" />
                </div>
            </div>
            <div class="w-1/2">
                <div>
                    <p> Blob </p>
                    <Input id="blobCloaker" placeholder="Redirect url (EX: https://google.com)" />
                </div>
                <div class="mt-2">
                    <Button id="blobLaunch" text="Cloak!" icon="material-symbols:open-in-new" />
                </div>
            </div>
        </div>
    </div>
</SettingsLayout>
<script>
    const handleAb = async (settings: Settings, sw: SW, storage: StoreManager<"radius||settings">) => {
        const input = document.getElementById("aboutBlankCloaker") as HTMLInputElement;
        const button = document.getElementById("aboutBlankLaunch") as HTMLButtonElement;
        
        if (!input || !button) {
            console.error("About Blank elements not found");
            return;
        }
        
        button.addEventListener("click", () => {
            const url = sw.search(input.value, storage.getVal('searchEngine'));
            settings.cloak(url).aboutBlank();
        });
    };

    const handleBlob = async (settings: Settings, sw: SW, storage: StoreManager<"radius||settings">) => {
        const input = document.getElementById("blobCloaker") as HTMLInputElement;
        const button = document.getElementById("blobLaunch") as HTMLButtonElement;
        
        if (!input || !button) {
            console.error("Blob elements not found");
            return;
        }
        
        button.addEventListener("click", () => {
            const url = sw.search(input.value, storage.getVal('searchEngine'));
            settings.cloak(url).blob();
        });
    };

    document.addEventListener('astro:page-load', async () => {
        try {
            const settings = await Settings.getInstance();
            const sw = SW.getInstance().next().value!;
            const storageManager = new StoreManager<"radius||settings">("radius||settings");
            await handleAb(settings, sw, storageManager);
            await handleBlob(settings, sw, storageManager);
        }
        catch (err) {
            console.error("Failed to initialize cloaking page:", err);
        }
    });
</script>
